<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Janus 评测结果（横向对比）</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; margin: 16px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    h2 { margin: 28px 0 10px; font-size: 18px; }
    .muted { color: #666; font-size: 12px; }
    table { border-collapse: collapse; width: 100%; margin: 8px 0 18px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: center; }
    th { background: #f6f6f6; }
    .datasets { margin-bottom: 24px; }

    /* 对比网格 */
    .compare { overflow-x: auto; }
    .grid-header, .grid-row {
      display: grid;
      gap: 10px;
      align-items: start;
    }
    /* 第一列为行号/提示信息列（可选），其余 7 列为数据集 */
    .grid-header {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
      border-bottom: 1px solid #eee;
      padding: 8px 0;
      margin-top: 8px;
    }
    .grid-row {
      border-bottom: 1px dashed #eee;
      padding: 10px 0;
    }
    .col-title, .cell {
      min-width: 220px;
    }
    .col-title small { display: block; color: #777; font-weight: normal; }

    /* 卡片 */
    .card { border: 1px solid #ddd; border-radius: 6px; overflow: hidden; background: #fff; }
    .scores { font-size: 12px; padding: 6px 8px; background: #fafafa; border-bottom: 1px solid #eee; white-space: normal; line-height: 1.35; }
    .scores div { margin: 2px 0; }
    .imgwrap { display: block; width: 100%; aspect-ratio: 1/1; background: #f2f2f2; overflow: hidden; }
    .imgwrap img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .caption { padding: 6px 8px; font-size: 12px; color: #333; }
    .err { color: #c00; font-size: 12px; margin: 6px 0; }
    code { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; }

    /* 行首（编号+prompt） */
    .row-info { font-size: 12px; color: #444; }
    .row-info .pid { font-weight: 600; margin-right: 6px; }
    .row-info .prompt { color: #666; }

    /* 占位 */
    .placeholder { display: flex; align-items: center; justify-content: center; border: 1px dashed #ddd; border-radius: 6px; min-height: 120px; color: #999; font-size: 12px; background: #fafafa; }
  </style>
</head>
<body>
  <h1>Janus 评测结果（横向对比 / 每项分数单独换行）</h1>
  <div class="muted">顶部为各数据集平均分；下方按 <code>prompt_idx</code> 横向对比，每列为一个数据集（normal 在最左）。每张图上方分数一行一个。</div>

  <div id="summary" class="datasets"></div>

  <div id="content" class="compare"></div>

  <script>
  // 配置：所有集合文件夹（相对于本页）—— normal 放最左
  const DATASETS = [
    'normal',
    'Janus_llama_dola_early_exit',
    'Janus_llama_dola_no_early_exit',
    'Janus_VIT_dola_early_exit',
    'Janus_VIT_dola_no_early_exit',
    'Janus_combined_dola_no_early_exit',
    'Janus_combined_dola_early_exit',
  ];
  const CSV_NAME = 'janus_eval_scores.csv';
  const JSON_NAME = 'janus_eval_scores.json';
  const METRICS = ['HPSv2Score','VQAScore','CLIPScore','ITMScore','PickScore','ImageReward'];

  // 简单 CSV 解析（支持带引号与逗号）
  function parseCSV(text) {
    const rows = [];
    let i = 0, field = '', row = [], inQuotes = false;
    while (i < text.length) {
      const c = text[i];
      if (inQuotes) {
        if (c === '"') {
          if (text[i+1] === '"') { field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        } else { field += c; i++; continue; }
      } else {
        if (c === '"') { inQuotes = true; i++; continue; }
        if (c === ',') { row.push(field); field = ''; i++; continue; }
        if (c === '\n' || c === '\r') {
          if (c === '\r' && text[i+1] === '\n') i++;
          row.push(field); field = '';
          if (row.length && !(row.length === 1 && row[0] === '')) rows.push(row);
          row = []; i++; continue;
        }
        field += c; i++;
      }
    }
    if (field.length || row.length) { row.push(field); rows.push(row); }
    return rows;
  }

  function toRelPath(base, p) {
    if (!p) return '';
    let s = String(p).replace(/\\/g, '/');
    if (!s.startsWith('/')) return s.replace(/^\.\/+/, '');
    const needle = `/${base}/`;
    const i = s.lastIndexOf(needle);
    if (i >= 0) return s.substring(i + needle.length);
    return s;
  }

  async function loadDataset(ds) {
    const base = ds.replace(/\/$/, '');
    const jsonUrl = `${base}/${JSON_NAME}`;
    const csvUrl = `${base}/${CSV_NAME}`;
    try {
      const r = await fetch(jsonUrl);
      if (r.ok) {
        const data = await r.json();
        if (data && Array.isArray(data.per_image)) {
          data.per_image.forEach(it => {
            if (it && typeof it.image_path === 'string') {
              const rel = toRelPath(base, it.image_path);
              it.image_path = rel;
            }
          });
        }
        return { type: 'json', base, data };
      }
    } catch (e) { /* ignore */ }
    const r2 = await fetch(csvUrl);
    if (!r2.ok) throw new Error(`加载失败: ${csvUrl}`);
    const text = await r2.text();
    const rows = parseCSV(text);
    if (!rows.length) throw new Error('空 CSV');
    const header = rows[0];
    const idx = { prompt_idx: header.indexOf('prompt_idx'), prompt: header.indexOf('prompt'), image_path: header.indexOf('image_path') };
    const midx = Object.fromEntries(METRICS.map(m => [m, header.indexOf(m)]));
    const per_image = [];
    for (let i=1;i<rows.length;i++) {
      const r = rows[i];
      if (r[0] === 'AVERAGE') continue;
      const item = {
        prompt_idx: Number(r[idx.prompt_idx]),
        prompt: JSON.parse(r[idx.prompt] || '""'),
        image_path: toRelPath(base, JSON.parse(r[idx.image_path] || '""')),
      };
      METRICS.forEach(m => { item[m] = r[midx[m]] ? Number(r[midx[m]]) : null; });
      per_image.push(item);
    }
    const last = rows[rows.length - 1];
    const averages = {};
    METRICS.forEach(m => {
      const j = header.indexOf(m);
      averages[m] = j >= 0 && last && last[0] === 'AVERAGE' && last[j] !== '' ? Number(last[j]) : null;
    });
    return { type: 'csv', base, data: { per_image, averages } };
  }

  function fmt(x) { return (x === null || isNaN(x)) ? '' : Number(x).toFixed(4); }

  function renderSummary(container, datasets) {
    const tbl = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    ['数据集', ...METRICS].forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
    thead.appendChild(trh); tbl.appendChild(thead);
    const tbody = document.createElement('tbody');
    datasets.forEach(ds => {
      const tr = document.createElement('tr');
      const name = document.createElement('td'); name.textContent = ds.base; tr.appendChild(name);
      METRICS.forEach(m => { const td = document.createElement('td'); td.textContent = fmt(ds.data.averages?.[m] ?? null); tr.appendChild(td); });
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
    container.innerHTML = '<h2>各数据集平均分（按列）</h2>';
    container.appendChild(tbl);
  }

  function buildIndexMap(ds) {
    const map = new Map();
    (ds.data.per_image || []).forEach(it => {
      if (!map.has(it.prompt_idx)) map.set(it.prompt_idx, it);
    });
    return map;
  }

  function renderComparison(container, datasets) {
    const header = document.createElement('div');
    header.className = 'grid-header';
    header.style.gridTemplateColumns = `minmax(240px, 1fr) ${' minmax(220px, 1fr)'.repeat(datasets.length)}`;

    // 左上角标题（行信息列）
    const leftTitle = document.createElement('div');
    leftTitle.className = 'col-title';
    leftTitle.innerHTML = '<strong>编号 & Prompt</strong><small>同编号横向对比</small>';
    header.appendChild(leftTitle);

    // 各数据集列标题
    datasets.forEach(ds => {
      const th = document.createElement('div');
      th.className = 'col-title';
      th.innerHTML = `<strong>${ds.base}</strong>`;
      header.appendChild(th);
    });

    // 收集所有 prompt_idx
    const allIdx = new Set();
    const maps = datasets.map(ds => buildIndexMap(ds));
    maps.forEach(m => { for (const k of m.keys()) allIdx.add(k); });
    const sortedIdx = Array.from(allIdx).sort((a,b)=>a-b);

    container.appendChild(header);

    // 每一行：一个 prompt_idx
    sortedIdx.forEach(pid => {
      const row = document.createElement('div');
      row.className = 'grid-row';
      row.style.gridTemplateColumns = `minmax(240px, 1fr) ${' minmax(220px, 1fr)'.repeat(datasets.length)}`;

      // 行信息（编号 + 任意数据集的 prompt 作为展示）
      const info = document.createElement('div');
      info.className = 'row-info';
      // 找到第一个包含该 pid 的条目来显示 prompt 文本
      let promptText = '';
      for (const m of maps) {
        if (m.has(pid)) { promptText = m.get(pid).prompt ?? ''; break; }
      }
      info.innerHTML = `<span class="pid">#${pid}</span><span class="prompt">${promptText}</span>`;
      row.appendChild(info);

      // 各数据集对应单元格
      datasets.forEach((ds, i) => {
        const cell = document.createElement('div');
        cell.className = 'cell';
        const item = maps[i].get(pid);
        if (!item) {
          const ph = document.createElement('div');
          ph.className = 'placeholder';
          ph.textContent = '该编号在此数据集中不存在';
          cell.appendChild(ph);
        } else {
          const card = document.createElement('div');
          card.className = 'card';

          // 分数：逐行显示
          const scores = document.createElement('div');
          scores.className = 'scores';
          METRICS.forEach(m => {
            const line = document.createElement('div');
            line.textContent = `${m.replace('Score','')}: ${fmt(item[m])}`;
            scores.appendChild(line);
          });
          card.appendChild(scores);

          // 图片
          const imgw = document.createElement('a');
          imgw.className = 'imgwrap';
          const img = document.createElement('img');
          const relImg = toRelPath(ds.base, item.image_path || '');
          img.loading = 'lazy';
          img.src = `${ds.base}/${relImg}`;
          img.alt = item.prompt ?? '';
          imgw.href = img.src;
          imgw.target = '_blank';
          imgw.appendChild(img);
          card.appendChild(imgw);

          // caption
          const cap = document.createElement('div');
          cap.className = 'caption';
          cap.textContent = `#${item.prompt_idx} ${item.prompt ?? ''}`;
          card.appendChild(cap);

          cell.appendChild(card);
        }
        row.appendChild(cell);
      });

      container.appendChild(row);
    });
  }

  (async function main(){
    const loaded = [];
    for (const ds of DATASETS) {
      try {
        const d = await loadDataset(ds);
        loaded.push(d);
      } catch (e) {
        const warn = document.createElement('div');
        warn.className = 'err';
        warn.textContent = `跳过 ${ds}: 未找到 ${JSON_NAME} 或 ${CSV_NAME}`;
        document.getElementById('content').appendChild(warn);
      }
    }
    if (loaded.length) {
      renderSummary(document.getElementById('summary'), loaded);
      renderComparison(document.getElementById('content'), loaded);
    }
  })();
  </script>
</body>
</html>
